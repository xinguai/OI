二进制第k位查询问题 By strongoier

【例1】BZOJ 1273 序列

题目大意：

给出一个N(1 <= N <= 10^5)个数的序列，有两种共M(1 <= M <= 10^5)个操作：整个序列加上x；查询整个序列中二进制第k(0 <= k < 16)位为1的数的个数。

算法分析：

考虑只有询问的情况，二进制第k位为1的数有哪些呢？我们很容易发现，超过k位的不可能对答案造成影响，因此我们只需要考虑每个数的后面k位，形如1000... ~ 1111...即2^k ~ 2^(k + 1) - 1的都满足要求。
那么，我们把每个数的倒数k位都存下来，记录部分和s[k][d]表示倒数k位小于等于d的数的个数。那么，询问就转化为了一个区间查询问题，对部分和作差即可。
考虑有了增加操作，我们维护一个全局累加值x，将我们的查询区间的左右端点都减x得出原序列的区间即可，注意处理进位1次（也最多只可能1次）的情况。时间复杂度O(N + M)。


【例2】BZOJ 2568 比特集合

题目大意：

维护一个初始为空集的集合S，进行4种共N(1 <= N <= 5 * 10^5)个操作：将元素M插入集合S；将集合S中所有等于M的元素删除；将集合S中的所有元素都增加数值M；查询集合满足二进制第k位为1的元素个数。

算法分析：

对于只有询问和增加操作的分析同上。
考虑插入和删除操作，显然序列会进行非整体的变动，因此我们不能简单计算部分和，而要使用树状数组来维护。我们用一个set来维护这个集合去掉x的值，那么插入和删除的值都进行对应的修正，然后再维护树状数组即可。
时间复杂度O(NlogN)。
